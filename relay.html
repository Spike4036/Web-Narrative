<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Protocol NYX — Relay Inbox</title>
<style>
  :root{
    --bg-0:#05070E; --ink:#E6EEF7; --muted:#9FB0C6;
    --panel:#141C2C; --panel2:#1B2437; --line:rgba(230,238,247,.18);
    --accent:#89C7FF; --ok:#7DF7D4; --warn:#FF6B6B; --dither:#C8D6F1;
    --ui-font:'Share Tech Mono','IBM Plex Mono','Space Mono',ui-monospace,Consolas,Menlo,monospace;
  }
  html,body{height:100%;margin:0;background:var(--bg-0);color:var(--ink);font:14px/1.6 var(--ui-font);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:0 auto;padding:14px;display:grid;gap:12px}
  .panel{border:1px solid var(--line);border-radius:12px;padding:12px;background:linear-gradient(180deg,var(--panel) 0%,var(--panel2) 100%)}
  h1{font-size:16px;margin:0 0 6px}
  .sub{margin:0 0 8px;color:var(--muted);font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .col{display:flex;flex-direction:column;min-height:0}
  .log{flex:1;overflow:auto;background:#0b1222;border:1px solid var(--line);border-radius:8px;padding:8px;color:#cfe1ff}
  .item{border-bottom:1px dashed var(--line);padding:8px 4px}
  .item:last-child{border-bottom:none}
  .game{display:flex;flex-direction:column;gap:8px}
  .scope{height:46px;background:#0b1222;border:1px solid var(--line);border-radius:8px;overflow:hidden;position:relative;margin-bottom:8px}
  .scope::before{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent 0, rgba(137,199,255,.14) 50%, transparent 100%); animation:sweep 2.6s linear infinite}
  @keyframes sweep{from{transform:translateX(-100%)} to{transform:translateX(100%)}}
  .msg{min-height:140px;background:#0b1222;border:1px solid var(--line);border-radius:8px;padding:10px;white-space:pre-wrap}
  .msg span.bad{color:#ffd5d5;text-decoration:underline dotted}
  .btnrow{display:flex;gap:8px;flex-wrap:wrap}
  button,.link{appearance:none;border:1px solid var(--line);background:#1a2336;color:var(--ink);padding:8px 12px;border-radius:10px;font:inherit;cursor:pointer}
  button:hover,.link:hover{transform:translateY(-1px)}
  .ok{border-color:rgba(125,247,212,.25);color:#d5fff4}
  .warn{border-color:rgba(255,107,107,.28);color:#ffd5d5}
  .foot{display:flex;justify-content:space-between;align-items:center;color:#9fb0c6;font-size:12px}
  .kbd{border:1px solid var(--line);padding:2px 6px;border-radius:6px;background:#0b1222;color:#a9b7d6;font-size:11px}

  /* CRT overlays */
  .crt-noise,.crt-scan,.crt-ab{position:fixed;inset:0;pointer-events:none;mix-blend-mode:soft-light}
  .crt-noise{z-index:2;opacity:.08;background:radial-gradient(rgba(255,255,255,.08) 1px,transparent 1px);background-size:3px 3px}
  .crt-scan{z-index:3;opacity:.06;background:linear-gradient(rgba(255,255,255,.08) 1px, transparent 1px);background-size:100% 3px;animation:scan 6s linear infinite}
  @keyframes scan{to{transform:translateY(3px)}}
  .crt-ab::before,.crt-ab::after{content:"";position:absolute;inset:0;z-index:1;mix-blend-mode:screen;pointer-events:none}
  .crt-ab::before{filter:blur(0.4px);box-shadow:inset 0 0 0 1px rgba(255,0,40,.08)}
  .crt-ab::after {filter:blur(0.4px);box-shadow:inset 0 0 0 1px rgba(0,200,255,.08)}
</style>
</head>
<body>
<div class="wrap">
  <header class="panel">
    <h1>Relay Inbox — Interstellar Messages</h1>
    <p class="sub">Receive messages from other colonies. Text arrives with corruption. Click a corrupted character and type the correct letter. Score tracks time/accuracy.</p>
    <div class="btnrow">
      <a href="observatory.html" class="link">Open Observatory (Own Planet)</a>
      <a href="index.html" class="link">Back</a>
    </div>
  </header>

  <section class="row">
    <aside class="panel col">
      <h2 style="margin:0 0 6px;font-size:14px">Traffic Log</h2>
      <div id="log" class="log" aria-live="polite"></div>
    </aside>

    <main class="panel col">
      <div class="game">
        <div class="scope" aria-hidden="true"></div>
        <div id="msg" class="msg" tabindex="0" aria-label="Corrupted message"></div>
        <div class="btnrow">
          <button id="btnNew" class="ok">Next Message</button>
          <button id="btnHint">Reveal One Correct Char</button>
          <button id="btnShuffle">Re-corrupt</button>
          <button id="btnMute">Toggle Noise</button>
        </div>
        <div class="foot">
          <span id="score">Score: 0 · Time: 0.0s · Accuracy: 100%</span>
          <span>Shortcuts: <span class="kbd">N</span> next · <span class="kbd">H</span> hint · <span class="kbd">M</span> noise</span>
        </div>
      </div>
    </main>
  </section>
</div>
<div class="crt-noise" aria-hidden="true"></div><div class="crt-scan" aria-hidden="true"></div><div class="crt-ab" aria-hidden="true"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/addons/p5.sound.min.js"></script>
<script>
/* ===== Messages from other colonies ===== */
const SOURCES = [
  "Colony Helix-4: Do not transmit high-power signals. The path is visible to hostile entities.",
  "Outpost Vesta: Our relay failed after a storm. Silent mode kept surface intact for now.",
  "Station Kallisto: If you must warn others, drop passive beacons at L-points only.",
  "Orchid Belt Hub: We lost three cities during broadcast tests. Do not repeat our mistake.",
  "Frontier Lyra: Crew mental strain increases with static. Use tone stabilization sparingly.",
  "Delta Gate: We recorded distortions forming around the planet after repeated calls.",
  "Ulysses Anchorage: If any world still listens, conserve power and remain unlit at night."
];

/* ===== Traffic log ===== */
const logEl = document.getElementById('log');
function logLine(t){ const d=document.createElement('div'); d.className='item'; d.textContent=new Date().toISOString().replace('T',' ').slice(0,19)+'  ·  '+t; logEl.prepend(d); }
logLine('Relay link established.');

/* ===== Radio-dark noise ===== */
let hiss, audioOn=true;
function setupNoise(){ hiss = new p5.Noise('white'); hiss.amp(0); hiss.start(); hiss.amp(0.02, 1.0); }
function toggleNoise(){ audioOn=!audioOn; hiss.amp(audioOn?0.02:0, 0.5); logLine(audioOn?'RF noise on.':'RF noise muted.'); }
setupNoise();

/* ===== Corruption engine ===== */
const msgEl = document.getElementById('msg'); const scoreEl = document.getElementById('score');
const glyphs = "█▒▓/\\|<>[]{}()*#@&%$!?~^+=";
let target="", corrupt=[], selectedIndex=-1, startTime=0, solvedCount=0, totalKeystrokes=0, correctKeystrokes=0;

function newMessage(){ target=SOURCES[Math.floor(Math.random()*SOURCES.length)]; corrupt=corruptText(target,0.18); selectedIndex=-1; startTime=performance.now(); render(); logLine('Incoming message received. Corruption detected.'); }
function corruptText(s,rate){ return s.split('').map(ch=>{ if(/\s/.test(ch)) return {c:ch, good:ch, bad:false}; if(Math.random()<rate){const g=glyphs[Math.floor(Math.random()*glyphs.length)]; return {c:g, good:ch, bad:true};} else return {c:ch, good:ch, bad:false}; }); }
function render(){ msgEl.innerHTML=''; corrupt.forEach((o,i)=>{ const span=document.createElement('span'); span.textContent=o.c; if(o.bad) span.className='bad'; if(i===selectedIndex) span.style.background='rgba(137,199,255,.25)'; span.onclick=()=>{selectedIndex=i; msgEl.focus(); render();}; msgEl.appendChild(span); }); updateScore(); }
function updateScore(){ const time=(performance.now()-startTime)/1000; const acc= totalKeystrokes>0? Math.max(0,Math.min(100,Math.round(100*correctKeystrokes/totalKeystrokes))) : 100; scoreEl.textContent=`Score: ${solvedCount} · Time: ${time.toFixed(1)}s · Accuracy: ${acc}%`; }
function checkSolved(){ const ok=corrupt.every(o=>o.c===o.good); if(ok){ solvedCount++; logLine('Message reconstructed and stored.'); } return ok; }
function revealOne(){ const wrong=corrupt.map((o,i)=>({o,i})).filter(e=>e.o.c!==e.o.good); if(wrong.length===0) return; const pick=wrong[Math.floor(Math.random()*wrong.length)]; pick.o.c=pick.o.good; pick.o.bad=false; selectedIndex=pick.i; render(); checkSolved(); }

msgEl.addEventListener('keydown', (e)=>{
  if(selectedIndex<0) return; const key=e.key;
  if(key.length===1){ totalKeystrokes++; corrupt[selectedIndex].c=key; corrupt[selectedIndex].bad=(corrupt[selectedIndex].c!==corrupt[selectedIndex].good); if(!corrupt[selectedIndex].bad) correctKeystrokes++;
    let i=selectedIndex+1; while(i<corrupt.length && /\s/.test(corrupt[i].good)) i++; selectedIndex=(i<corrupt.length?i:-1);
    render(); if(checkSolved()) setTimeout(newMessage,800);
  }else if(key==='ArrowLeft'){ let i=selectedIndex-1; while(i>=0 && /\s/.test(corrupt[i].good)) i--; if(i>=0){selectedIndex=i; render();} }
  else if(key==='ArrowRight'){ let i=selectedIndex+1; while(i<corrupt.length && /\s/.test(corrupt[i].good)) i++; if(i<corrupt.length){selectedIndex=i; render();} }
});

document.getElementById('btnNew').onclick = newMessage;
document.getElementById('btnHint').onclick= ()=> revealOne();
document.getElementById('btnShuffle').onclick= ()=>{ corrupt=corruptText(target,0.18); render(); };
document.getElementById('btnMute').onclick = toggleNoise;
addEventListener('keydown',(e)=>{ if(e.repeat) return; const k=e.key.toLowerCase(); if(k==='n') newMessage(); if(k==='h') revealOne(); if(k==='m') toggleNoise(); });

newMessage();
</script>
</body>
</html>

